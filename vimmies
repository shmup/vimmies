#!/usr/bin/env bash
# usage: ./vimmies [OPTION]

VIM_PATH=$HOME/.vim
PLUGINS_PATH=$VIM_PATH/pack/plugins/start
CACHE=$VIM_PATH/junk/cache

REPO=/home/jared/src/vim
PY2=/usr/lib/python2.7/config-x86_64-linux-gnu
PY3=/usr/lib/python3.6/config-3.6m-x86_64-linux-gnu
RUBY=$(which ruby)
PROCS=4
YOU="skeletor"

help="$(basename "$0") [OPTION]

  - setup           setup vimmies
  - update          update all the submodules
  - upgrade         upgrade vim
  - install <url>   install submodule
  - remove <name>   remove submodule
"

bail() { echo "$1" && exit 0; } # clean msg & exit

_setup() {
  git submodule update --init --recursive
  sudo ln -s $VIM_PATH/vimmies_completion /etc/bash_completion.d/vimmies_completion
  mkdir -p $VIM_PATH/junk/{backup,swp,undo,view}
}

_update() {
  git submodule update --remote --merge
}

_upgrade() {
  if cd $REPO; then git pull; else git clone https://github.com/vim/vim.git $REPO; fi

  sudo rm -rf /usr/local/share/vim /usr/bin/vim

  cd "$REPO" || exit

  make distclean

  ./configure \
  --enable-multibyte \
  --enable-perlinterp=dynamic \
  --enable-rubyinterp=dynamic \
  --with-ruby-command="$RUBY" \
  --enable-pythoninterp=dynamic \
  --with-python-config-dir="$PY2" \
  --enable-python3interp \
  --with-python3-config-dir="$PY3" \
  --enable-luainterp \
  --with-luajit \
  --enable-cscope \
  --enable-gui=auto \
  --with-features=huge \
  --with-x \
  --enable-fontset \
  --enable-largefile \
  --disable-netbeans \
  --with-compiledby="$YOU" \
  --enable-fail-if-missing

  make -j "$PROCS" && sudo make -j "$PROCS" install
}

_install() {
  if [[ -z $2 ]]; then
    PLUGIN=$(cat $CACHE | sort | uniq | fzy)
  else
    PLUGIN=$2
  fi

  [[ -z $PLUGIN ]] && exit 0;

  cd "$PLUGINS_PATH" || exit
  git submodule add --force "$PLUGIN"
}

_remove() {
  if ! [ -x "$(command -v fzy)" ]; then
    PLUGIN=$2
  else
    PLUGIN=$(ls $PLUGINS_PATH | fzy)
  fi

  [[ -z $PLUGIN ]] && exit 0;

  if [[ ! -d $PLUGINS_PATH/$PLUGIN ]]; then bail "Submodule doesn't exist"; fi

  # cache some shit and trim dupes
  cd $PLUGINS_PATH/$PLUGIN
  git remote get-url origin >> $CACHE
  [ -d "$OLDPWD" ] && cd "$OLDPWD"

  git submodule deinit -f "$PLUGINS_PATH/$PLUGIN"
  git rm -f "$PLUGINS_PATH/$PLUGIN"
  rm -Rf "$PLUGINS_PATH/$PLUGIN"
}

if [[ $(type -t _"$1") = 'function' ]]; then
    # run all functions from .vim but return you back at the end
    cd "$VIM_PATH" || exit
    _$1 $*
    [ -d "$OLDPWD" ] && cd "$OLDPWD"
else
  echo "$help"
fi
